<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`gfs-checkout-data`
Communication proxy and data handler for the Checkout API

@demo demo/index.html
-->

<dom-module id="gfs-checkout-data">
  <template>
    <iron-ajax id='createCheckoutSession'
      debounce-duration="300"
      handle-as="json"
      method="POST"
      on-response="_newSessionStarted"
      content-type="application/json"></iron-ajax>
    <iron-ajax id='getCheckoutOptions'
      debounce-duration="300"
      handle-as="json"
      method="GET"
      on-response="_newOptionsAvailable"
      content-type="application/json"></iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'gfs-checkout-data',

      properties: {
        checkoutUri: {
          type: String,
          value: "http://rest.api.checkout.justshoutgfs.com/api"
        },
        checkoutRequest: {
          type: String,
          value: ""
        },
        checkoutToken: {
          type: String,
          value: ""
        }
      },
      observers: [
        '_updateResponse(checkoutRequest, checkoutToken)'
      ],
      _updateResponse: function(request, token) {
        if(request === "" || token === "") return;

        var server = this.$.createCheckoutSession;
        server.url = this.checkoutUri + "/CheckoutSession"
        server.headers = this._getBearerToken();
        server.body = JSON.parse(request);

        server.generateRequest();
      },
      _newSessionStarted: function(e) {
        var server = this.$.getCheckoutOptions;
        var sessionId = e.detail.response.substring(e.detail.response.lastIndexOf("/") + 1);

        server.url = this.checkoutUri + "/CheckoutSession/" + sessionId;
        server.headers = this._getBearerToken();
        server.generateRequest();
      },
      _newOptionsAvailable: function(e) {
        this.fire('options', {});

        var elem = this;

        this._processStandard(function(options){
          elem.fire('newStandardOptions', options);
        });
        this._processDayDefinite(function(dayDefinite){
          elem.fire('newDayDefiniteOptions', dayDefinite);
        });
        this._processDropPoints(function(dropPoints){
          elem.fire('newDropPoints', dropPoints);
        });
      },
      _getBearerToken: function() {
        return { "authorization": "Bearer " + this.checkoutToken };
      },
      _processStandard: function(callBack) {
        return callBack( { foo : "bar" } );
      },
      _processDayDefinite: function(callBack) {
        return callBack( { foo : "bar" } );
      },
      _processDropPoints: function(callBack) {
        return callBack( { foo : "bar" } );
      }
    });
  </script>
</dom-module>
