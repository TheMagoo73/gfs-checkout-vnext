<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`gfs-checkout-data`
Communication proxy and data handler for the Checkout API

@demo demo/gfs-checkout-data-demo.html
-->

<dom-module id="gfs-checkout-data">
  <template>
    <iron-ajax id='createCheckoutSession'
      debounce-duration="300"
      handle-as="json"
      method="POST"
      on-response="_newSessionStarted"
      content-type="application/json"></iron-ajax>
    <iron-ajax id='getCheckoutOptions'
      debounce-duration="300"
      handle-as="json"
      method="GET"
      on-response="_newOptionsAvailable"
      content-type="application/json"></iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'gfs-checkout-data',

      /**
      * Fired when a request is sent to Checkout.
      *
      * @event getoptionsstart
      */

      /**
      * Fired when a response is returned from Checkout.
      *
      * @event getoptionscomplete
      */

      /**
      * Fired when new non-day-definite, non-drop-point options are available.
      *
      * @event newstandardoptions
      */

      /**
      * Fired new non-day-definite, drop-point options are available
      *
      * @event newstandarddroppointoptions
      */

      /**
      * Fired when new day-definite, non-drop-point options are available
      *
      * @event newdaydefiniteoptions
      */

      /**
      * Fired when new day day-definite, drop-point options are available
      *
      * @event newdaydefinitedroppointoptions
      */

      /**
      * Fired when new drop-points are available
      *
      * @event newdroppoints
      */

      properties: {
        checkoutUri: {
          type: String,
          value: "http://rest.api.checkout.justshoutgfs.com/api"
        },
        checkoutRequest: {
          type: String,
          value: ""
        },
        checkoutToken: {
          type: String,
          value: ""
        }
      },
      observers: [
        '_updateResponse(checkoutRequest, checkoutToken)'
      ],
      _updateResponse: function(request, token) {
        if(request === "" || token === "") return;

        this.fire('getoptionsstart')

        var server = this.$.createCheckoutSession;
        server.url = this.checkoutUri + "/CheckoutSession"
        server.headers = this._getBearerToken();
        server.body = JSON.parse(atob(request));

        server.generateRequest();
      },
      _newSessionStarted: function(e) {
        var server = this.$.getCheckoutOptions;
        var sessionId = e.detail.response.substring(e.detail.response.lastIndexOf("/") + 1);

        server.url = this.checkoutUri + "/CheckoutSession/" + sessionId;
        server.headers = this._getBearerToken();
        server.generateRequest();
      },
      _newOptionsAvailable: function(e) {
        var elem = this;
        var newOptions = e.detail.response;

        this.fire('getoptionscomplete', newOptions);


        this._processStandard(newOptions, function(options){
          elem.fire('newstandardoptions', options);
        });
        this._processStandardDropPoint(newOptions, function(options){
          elem.fire('newstandarddroppointoptions', options);
        });
        this._processDayDefinite(newOptions, function(options){
          elem.fire('newdaydefiniteoptions', options);
        });
        this._processDayDefiniteDropPoint(newOptions, function(options){
          elem.fire('newdaydefinitedroppointoptions', options);
        });
        this._processDropPoints(newOptions, function(dropPoints){
          elem.fire('newdroppoints', dropPoints);
        });
      },
      _getBearerToken: function() {
        return { "authorization": "Bearer " + this.checkoutToken };
      },
      /**
       * Process the current response from Checkout, extract
       * the non-day-definite services that do not use Drop Points
       * for delivery, and return an array of objects representing
       * the services.
       *
       */
      _processStandard: function(options, callBack) {
        var rates = []

        options.nonDayDefinite.forEach((day) => {
          day.rates.forEach((rate) => {
            if(rate.serviceType.type == 'dmStandard')
            {
              rate.deliveryDate = day.deliveryDate;
              rates.push(rate);
            }
          });
        });

        return callBack( rates )
      },
      /**
       * Process the current response from Checkout, extract
       * the non-day-definite services that use Drop Points
       * for delivery, and return an array of objects representing
       * the services.
       *
       */
      _processStandardDropPoint: function(options, callBack) {
        var rates = []

        options.nonDayDefinite.forEach((day) => {
          day.rates.forEach((rate) => {
            if(rate.serviceType.type == 'dmStandardDropPoint')
            {
              rate.deliveryDate = day.deliveryDate;
              rates.push(rate);
            }
          });
        });

        return callBack( rates )
      },
      /**
       * Process the current response from Checkout, extract
       * the day-definite services that do not use Drop Points
       * for delivery, and return an array of objects representing
       * the services.
       *
       */
      _processDayDefinite: function(options, callBack) {
        var rates = []

        options.dayDefinite.forEach((day) => {
          day.rates.forEach((rate) => {
            if(rate.serviceType.type == 'dmStandard')
            {
              rate.deliveryDate = day.deliveryDate;
              rates.push(rate);
            }
          });
        });

        return callBack( rates )
      },
      /**
       * Process the current response from Checkout, extract
       * the day-definite services that do not Drop Points
       * for delivery, and return an array of objects representing
       * the services.
       *
       */
      _processDayDefiniteDropPoint: function(options, callBack) {
        var rates = []

        options.dayDefinite.forEach((day) => {
          day.rates.forEach((rate) => {
            if(rate.serviceType.type == 'dmStandardDropPoint')
            {
              rate.deliveryDate = day.deliveryDate;
              rates.push(rate);
            }
          });
        });

        return callBack( rates )
      },
      /**
       * Process the current response from Checkout and return
       * information on the Drop Points it contains
       *
       */
      _processDropPoints: function(options, callBack) {
        return callBack( options.droppoints );
      }
    });
  </script>
</dom-module>
